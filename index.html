<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ë—ã—Å—Ç—Ä—ã–π –ö–ª–∏–∫ ‚Äî –†—ã–±–Ω—ã–π –ò–Ω–¥–µ–∫—Å</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1d2338 0, #050814 55%, #020315 100%);
      color: #f9fafb;
      padding: 0 0 24px;
    }

    .wrapper {
      width: 100%;
      max-width: 1400px;
      padding: 16px 20px 24px;
    }

    /* ====== –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –æ–±—â–∏—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤ ====== */

    .top-counters {
      display: flex;
      gap: 16px;
      margin-bottom: 32px;
      justify-content: center;
    }

    .counter-card {
      flex: 1;
      max-width: 360px;
      background: radial-gradient(circle at top, rgba(30,64,175,0.75), rgba(15,23,42,0.98));
      border-radius: 18px;
      padding: 14px 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .counter-icon {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 0 18px rgba(0,0,0,0.6);
      background: radial-gradient(circle at 30% 20%, #fef3c7, #f59e0b 55%, #b45309 100%);
    }
    .counter-icon.diamond {
      background: radial-gradient(circle at 30% 20%, #bbf7d0, #22c55e 55%, #15803d 100%);
    }
    .counter-icon.star {
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #6366f1 55%, #312e81 100%);
    }

    .counter-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .counter-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #cbd5f5;
    }
    .counter-main {
      font-size: 22px;
      font-weight: 800;
    }
    .counter-sub {
      font-size: 12px;
      opacity: 0.85;
    }

    /* ====== –û—Å–Ω–æ–≤–Ω–æ–π –º–∞–∫–µ—Ç ====== */

    .main-layout {
      display: grid;
      grid-template-columns: 340px minmax(0, 1.2fr) 340px;
      gap: 18px;
      align-items: flex-start;
    }

    .card {
      background: radial-gradient(circle at top, rgba(15,23,42,0.96), #020617 80%);
      border-radius: 22px;
      padding: 16px 18px 18px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.75);
      border: 1px solid rgba(148,163,184,0.20);
    }

    /* ====== –õ–∏–¥–µ—Ä–±–æ—Ä–¥ ====== */

    .leaderboard-card {
      height: 640px;
      display: flex;
      flex-direction: column;
    }

    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .leaderboard-title {
      font-size: 18px;
      font-weight: 800;
    }
    .leaderboard-caption {
      font-size: 11px;
      opacity: 0.7;
    }

    .leaderboard-table {
      border-radius: 16px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(55,65,81,0.85);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .lb-head, .lb-row {
      display: grid;
      grid-template-columns: 40px 1fr 60px 70px;
      gap: 6px;
      padding: 6px 10px;
      font-size: 12px;
      align-items: center;
    }
    .lb-head {
      background: rgba(15,23,42,0.98);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
      border-bottom: 1px solid rgba(55,65,81,0.9);
    }

    .lb-rows {
      overflow-y: auto;
      flex: 1;
    }

    .lb-row {
      border-bottom: 1px solid rgba(31,41,55,0.7);
      color: #9ca3af;
    }
    .lb-row:nth-child(2n) {
      background: rgba(15,23,42,0.9);
    }

    .lb-rank {
      text-align: center;
      font-weight: 600;
      opacity: 0.9;
    }
    .lb-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .lb-fish, .lb-time {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .lb-row.rank-1 {
      background: radial-gradient(circle at left, rgba(250,204,21,0.16), rgba(15,23,42,0.95));
      color: #facc15;
      text-shadow: 0 0 14px rgba(250,204,21,0.9);
    }
    .lb-row.rank-2 {
      background: radial-gradient(circle at left, rgba(148,163,184,0.16), rgba(15,23,42,0.95));
      color: #e5e7eb;
      text-shadow: 0 0 10px rgba(156,163,175,0.95);
    }
    .lb-row.rank-3 {
      background: radial-gradient(circle at left, rgba(248,113,113,0.18), rgba(15,23,42,0.95));
      color: #fb923c;
      text-shadow: 0 0 12px rgba(251,146,60,0.95);
    }
    .lb-row.rank-default {
      color: #6b7280;
      opacity: 0.9;
    }

    .leaderboard-mybest {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: radial-gradient(circle at top, rgba(30,64,175,0.55), rgba(15,23,42,0.98));
      border: 1px solid rgba(129,140,248,0.8);
    }
    .lb-my-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      opacity: 0.9;
      margin-bottom: 4px;
    }
    .lb-my-body {
      font-size: 13px;
    }

    /* ====== –ò–≥—Ä–æ–≤–æ–π –±–ª–æ–∫ ====== */

    .game-card {
      height: 640px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .game-title {
      font-size: 26px;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #facc15;
      text-shadow: 0 0 22px rgba(250,204,21,0.95);
    }

    .run-score {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 26px;
      font-weight: 800;
    }
    .run-score-icon {
      width: 52px;
      height: 52px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      background: radial-gradient(circle at 30% 20%, #fef3c7, #f59e0b 55%, #b45309 100%);
      box-shadow: 0 0 20px rgba(251,191,36,0.95);
    }

    .game-timer-lives {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .timer-chip {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(55,65,81,0.9);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .hearts {
      display: flex;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #050814;
      border: 1px solid rgba(15,23,42,0.9);
      filter: drop-shadow(0 0 10px rgba(248,113,113,0.95));
    }

    .heart-full, .heart-empty {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      background: radial-gradient(circle at 30% 20%, #1f2937, #111827 60%, #0f172a 100%);
      color: #f87171;
    }
    .heart-empty {
      opacity: 0.35;
      filter: none;
    }

    .timer-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #020617;
      margin: 10px 0 12px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(30,64,175,0.8);
    }
    .timer-fill {
      position: absolute;
      inset: 0;
      width: 100%;
      transform-origin: left center;
      transform: scaleX(1);
      background: linear-gradient(90deg, #ef4444, #f97316, #fde047, #22c55e);
    }

    .run-inline-stats {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin: 10px 0 14px;
    }
    .run-inline-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      font-size: 12px;
    }
    .run-inline-icon {
      font-size: 16px;
    }
    .run-inline-label {
      opacity: 0.8;
    }
    .run-inline-value {
      font-weight: 700;
      color: #e5f9ff;
      min-width: 32px;
      text-align: right;
    }

    .circles-row {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-top: 22px;
      margin-bottom: 28px;
    }

    .circle-btn {
      width: 170px;
      height: 170px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top, #020617, #020617 60%, #020617 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 46px;
      cursor: pointer;
      position: relative;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
    }
    .circle-btn-inner {
      width: 84px;
      height: 84px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 44px;
    }
    .circle-btn.disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
    }

    .circle-btn.active-purple {
      border-color: rgba(168,85,247,0.95);
      background: radial-gradient(circle at top, #4c1d95, #7c3aed 55%, #4c1d95 100%);
      box-shadow: 0 0 32px rgba(168,85,247,0.95);
    }
    .circle-btn.active-bomb {
      border-color: rgba(248,113,113,0.95);
      background: radial-gradient(circle at top, #7f1d1d, #ef4444 55%, #7f1d1d 100%);
      box-shadow: 0 0 34px rgba(248,113,113,0.98);
    }
    .circle-btn.active-green {
      border-color: rgba(74,222,128,0.95);
      background: radial-gradient(circle at top, #14532d, #22c55e 55%, #14532d 100%);
      box-shadow: 0 0 32px rgba(74,222,128,0.98);
    }

    .circle-btn:hover:not(.disabled) {
      transform: translateY(-3px);
      box-shadow: 0 22px 44px rgba(0,0,0,0.85);
    }

    .circle-icon {
      text-shadow: 0 0 18px rgba(15,23,42,0.8);
    }

    .game-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .primary-btn {
      border: none;
      border-radius: 999px;
      padding: 12px 40px;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: linear-gradient(90deg, #facc15, #f97316);
      color: #111827;
      cursor: pointer;
      box-shadow: 0 16px 40px rgba(251,191,36,0.85);
      transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
    }
    .primary-btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.05);
      box-shadow: 0 20px 50px rgba(251,191,36,0.95);
    }
    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 10px 25px rgba(251,191,36,0.8);
    }

    .rules-link {
      margin-top: 4px;
      font-size: 12px;
      color: #f97316;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: 0.9;
    }
    .rules-link span.icon {
      color: #f97316;
    }

    /* ====== –†—ã–±–Ω—ã–π –∏–Ω–¥–µ–∫—Å ====== */

    .fish-card {
      height: 640px;
      display: flex;
      flex-direction: column;
    }

    .nick-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .nick-row-label {
      opacity: 0.8;
    }
    .nick-input-wrapper {
      flex: 1;
      background: rgba(15,23,42,0.95);
      border-radius: 999px;
      padding: 4px 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(55,65,81,0.95);
    }
    #nicknameInput {
      flex: 1;
      background: transparent;
      border: none;
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
    }
    #nicknameOkBtn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      cursor: pointer;
      background: linear-gradient(90deg, #facc15, #f97316);
      color: #111827;
      box-shadow: 0 6px 18px rgba(251,191,36,0.65);
      display: none;
    }

    .level-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .level-label {
      font-size: 13px;
      opacity: 0.78;
    }
    .level-value {
      font-size: 20px;
      font-weight: 800;
      color: #fde047;
      text-shadow: 0 0 18px rgba(250,204,21,0.95);
    }

    .fish-progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid rgba(55,65,81,0.95);
      overflow: hidden;
      margin-bottom: 12px;
    }
    .fish-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #22d3ee);
    }

    .fish-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
      overflow-y: auto;
    }

    .fish-cell {
      border-radius: 18px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), #020617 70%);
      border: 1px solid rgba(55,65,81,0.9);
      padding: 10px 8px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      min-height: 120px;
      position: relative;
    }

    .fish-icon-wrapper {
      width: 72px;
      height: 72px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      background: radial-gradient(circle at top, #0f172a, #020617 80%);
      box-shadow: 0 12px 26px rgba(0,0,0,0.8);
    }
    .fish-cell.unlocked .fish-icon-wrapper {
      background: radial-gradient(circle at top, #0ea5e9, #0369a1 60%, #0b1120 100%);
    }

    .fish-name {
      font-size: 12px;
      text-align: center;
      opacity: 0.86;
    }
    .fish-cost {
      font-size: 11px;
      opacity: 0.7;
    }
    .fish-cell.locked {
      opacity: 0.4;
    }

    .fish-cell.unlocked {
      border-color: rgba(52,211,153,0.95);
      box-shadow: 0 0 18px rgba(52,211,153,0.85);
    }

    .fish-unlock-badge {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(34,197,94,0.92);
      color: #022c22;
      font-weight: 700;
    }

    /* ====== –û–≤–µ—Ä–ª–µ–∏ ====== */

    .overlay-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      backdrop-filter: blur(8px);
    }
    .overlay-card {
      width: 100%;
      max-width: 720px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), #020617 80%);
      border-radius: 26px;
      padding: 24px 26px 22px;
      box-shadow: 0 26px 70px rgba(0,0,0,0.9);
      border: 1px solid rgba(148,163,184,0.45);
      text-align: center;
    }
    .overlay-icon {
      font-size: 64px;
      color: #ffe58a;
      text-shadow: 0 0 26px rgba(250,204,21,0.98);
    }
    .overlay-title {
      font-size: 30px;
      font-weight: 800;
      margin-top: 10px;
      margin-bottom: 6px;
    }
    .overlay-sub {
      font-size: 18px;
      opacity: 0.95;
      margin-bottom: 18px;
    }
    .overlay-rules {
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid rgba(55,65,81,0.85);
      text-align: left;
      font-size: 14px;
      line-height: 1.6;
    }
    .overlay-rules-row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
      align-items: flex-start;
    }
    .overlay-rules-row .icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .overlay-btn-row {
      margin-top: 18px;
      display: flex;
      justify-content: center;
    }

    /* —Å–ø–µ—Ü –æ–≤–µ—Ä–ª–µ–π —Ä–∞–∑–±–∏—Ç–æ–≥–æ —Å–µ—Ä–¥—Ü–∞ */

    #heartOverlay .overlay-card {
      max-width: 520px;
      padding-top: 40px;
      padding-bottom: 26px;
    }
    #heartOverlay .overlay-icon {
      font-size: 120px;
    }

    /* –•–µ–ª–ø-—ç–∫—Ä–∞–Ω */

    #helpOverlay .overlay-card {
      max-width: 760px;
    }

    .help-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
      margin-top: 10px;
    }

    .help-item {
      background: rgba(15,23,42,0.95);
      border-radius: 18px;
      padding: 10px 10px 12px;
      border: 1px solid rgba(55,65,81,0.85);
      text-align: center;
      font-size: 13px;
    }
    .help-circle {
      width: 82px;
      height: 82px;
      margin: 0 auto 6px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.9);
    }
    .help-circle.purple {
      background: radial-gradient(circle at top, #4c1d95, #7c3aed 55%, #4c1d95 100%);
    }
    .help-circle.red {
      background: radial-gradient(circle at top, #7f1d1d, #ef4444 55%, #7f1d1d 100%);
    }
    .help-circle.green {
      background: radial-gradient(circle at top, #14532d, #22c55e 55%, #14532d 100%);
    }
    .help-caption-strong {
      font-size: 14px;
      font-weight: 700;
    }
    .help-caption {
      opacity: 0.9;
      font-size: 13px;
      margin-top: 2px;
    }
    .help-footer {
      font-size: 14px;
      opacity: 0.95;
      margin-top: 8px;
      text-align: left;
    }

    /* –ü—Ä–æ—á–µ–µ */

    .hidden { display: none !important; }

    .mt-4 { margin-top: 16px; }

    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
      .leaderboard-card, .game-card, .fish-card {
        height: auto;
      }
    }
  </style>

  <!-- Firebase v8 SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
  <div class="wrapper">
    <!-- –í–µ—Ä—Ö–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∏ -->
    <div class="top-counters">
      <div class="counter-card">
        <div class="counter-icon">$</div>
        <div class="counter-text">
          <div class="counter-title">–ú–æ–Ω–µ—Ç—ã</div>
          <div class="counter-main" id="coinsAllMain">0</div>
          <div class="counter-sub">–ó–∞ –∏–≥—Ä—É: <span id="coinsRunTop">0</span></div>
        </div>
      </div>
      <div class="counter-card">
        <div class="counter-icon diamond">üíé</div>
        <div class="counter-text">
          <div class="counter-title">–ê–ª–º–∞–∑—ã</div>
          <div class="counter-main" id="diamondsAllMain">0</div>
          <div class="counter-sub">–ó–∞ –∏–≥—Ä—É: <span id="diamondsRunTop">0</span></div>
        </div>
      </div>
      <div class="counter-card">
        <div class="counter-icon star">‚≠ê</div>
        <div class="counter-text">
          <div class="counter-title">–ó–≤—ë–∑–¥—ã</div>
          <div class="counter-main" id="starsAllMain">0</div>
          <div class="counter-sub">–ó–∞ –∏–≥—Ä—É: <span id="starsRunTop">0</span></div>
        </div>
      </div>
    </div>

    <div class="main-layout">
      <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ -->
      <div class="card leaderboard-card">
        <div class="leaderboard-header">
          <div>
            <div class="leaderboard-title">–¢–æ–ø –∏–≥—Ä</div>
            <div class="leaderboard-caption">–û–±—â–∏–π –æ–Ω–ª–∞–π–Ω-—Ä–µ–π—Ç–∏–Ω–≥</div>
          </div>
        </div>

        <div class="leaderboard-table">
          <div class="lb-head">
            <div>#</div>
            <div>–ò–º—è</div>
            <div>–†—ã–±</div>
            <div>–í—Ä–µ–º—è</div>
          </div>
          <div id="leaderboardRows" class="lb-rows">
            <!-- rows -->
          </div>
        </div>

        <div class="leaderboard-mybest">
          <div class="lb-my-title">–ú–æ–π –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
          <div class="lb-my-body" id="myBestInfo">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>
        </div>
      </div>

      <!-- –ò–≥—Ä–æ–≤–æ–π –±–ª–æ–∫ -->
      <div class="card game-card">
        <div class="game-header">
          <div class="game-title">–ë—ã—Å—Ç—Ä—ã–π –∫–ª–∏–∫</div>
        </div>

        <div class="game-header" style="margin-top: 4px;">
          <div class="run-score">
            <div class="run-score-icon">$</div>
            <div id="scoreCurrent">0</div>
          </div>
          <div class="game-timer-lives">
            <div class="timer-chip">
              <span>‚è±</span>
              <span id="timerLabel">2.0 c</span>
            </div>
            <div class="hearts" id="heartsPanel">
              <span class="heart-full">‚ù§Ô∏è</span>
              <span class="heart-full">‚ù§Ô∏è</span>
              <span class="heart-full">‚ù§Ô∏è</span>
            </div>
          </div>
        </div>

        <div class="timer-bar">
          <div class="timer-fill" id="timerFill"></div>
        </div>

        <div class="run-inline-stats">
          <div class="run-inline-item">
            <span class="run-inline-icon">üíé</span>
            <span class="run-inline-label">–ê–ª–º–∞–∑—ã –∑–∞ –∏–≥—Ä—É</span>
            <span class="run-inline-value" id="diamondsRunInline">0</span>
          </div>
          <div class="run-inline-item">
            <span class="run-inline-icon">‚≠ê</span>
            <span class="run-inline-label">–ó–≤—ë–∑–¥—ã –∑–∞ –∏–≥—Ä—É</span>
            <span class="run-inline-value" id="starsRunInline">0</span>
          </div>
        </div>

        <div class="circles-row">
          <button class="circle-btn disabled" data-index="0">
            <div class="circle-btn-inner">
              <span class="circle-icon">‚ö°</span>
            </div>
          </button>
          <button class="circle-btn disabled" data-index="1">
            <div class="circle-btn-inner">
              <span class="circle-icon">‚ö°</span>
            </div>
          </button>
          <button class="circle-btn disabled" data-index="2">
            <div class="circle-btn-inner">
              <span class="circle-icon">‚ö°</span>
            </div>
          </button>
        </div>

        <div class="game-footer">
          <button id="startBtn" class="primary-btn">–ò–≥—Ä–∞—Ç—å</button>
          <div class="rules-link" id="rulesLink">
            <span class="icon">‚ùó</span>
            <span>–ü—Ä–∞–≤–∏–ª–∞</span>
          </div>
        </div>
      </div>

      <!-- –†—ã–±–Ω—ã–π –∏–Ω–¥–µ–∫—Å -->
      <div class="card fish-card">
        <div class="nick-row">
          <span class="nick-row-label">–ù–∏–∫:</span>
          <div class="nick-input-wrapper">
            <input id="nicknameInput" maxlength="16" />
            <button id="nicknameOkBtn">OK</button>
          </div>
        </div>

        <div class="level-row">
          <span class="level-label">–£—Ä–æ–≤–µ–Ω—å</span>
          <span class="level-value" id="levelValue">0 / 21</span>
        </div>

        <div class="fish-progress-bar">
          <div class="fish-progress-fill" id="fishProgressFill"></div>
        </div>

        <div class="fish-grid" id="fishGrid">
          <!-- –†—ã–±—ã -->
        </div>
      </div>
    </div>
  </div>

  <!-- –û–≤–µ—Ä–ª–µ–π –ø—Ä–∞–≤–∏–ª / –∫–æ–Ω—Ü–∞ –∏–≥—Ä—ã / —Ö–µ–ª–ø / —É–¥–∞—Ä –ø–æ —Å–µ—Ä–¥—Ü—É -->

  <!-- –ü—Ä–∞–≤–∏–ª–∞ -->
  <div id="rulesOverlay" class="overlay-backdrop">
    <div class="overlay-card">
      <div class="overlay-icon">üèÜ</div>
      <div class="overlay-title">–ü—Ä–∞–≤–∏–ª–∞</div>
      <div class="overlay-sub">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å –≤ ¬´–ë—ã—Å—Ç—Ä—ã–π –∫–ª–∏–∫¬ª</div>

      <button id="rulesPlayBtn" class="primary-btn">–ò–≥—Ä–∞—Ç—å</button>

      <div class="overlay-rules mt-4">
        <div class="overlay-rules-row">
          <div class="icon">üéØ</div>
          <div>–ù–∞–∂–∏–º–∞–π—Ç–µ <strong>—Ç–æ–ª—å–∫–æ –Ω–∞ —Å–≤–µ—Ç—è—â–∏–π—Å—è –∫—Ä—É–≥</strong>.</div>
        </div>
        <div class="overlay-rules-row">
          <div class="icon">‚è≥</div>
          <div>–ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞—É–Ω–¥–∞ ‚Äî <strong>2 —Å–µ–∫—É–Ω–¥—ã</strong>, –∑–∞ –∫–∞–∂–¥—É—é –Ω–æ–≤—É—é —Ä—ã–±—É —Ä–∞—É–Ω–¥ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ <strong>0,1 —Å</strong> (–¥–æ –º–∏–Ω–∏–º—É–º–∞ 0,5 —Å).</div>
        </div>
        <div class="overlay-rules-row">
          <div class="icon">üí£</div>
          <div>–ö—Ä–∞—Å–Ω—ã–π –∫—Ä—É–≥-–±–æ–º–±–∞ –≥–æ—Ä–∏—Ç <strong>–ø–æ–ª–æ–≤–∏–Ω—É –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—É–Ω–¥–∞</strong>: –∫–ª–∏–∫ –ø–æ –Ω–µ–º—É = <strong>–º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–∏–≥—Ä—ã—à</strong>, –ø—Ä–æ–ø—É—Å–∫ ‚Äî –±–µ–∑–æ–ø–∞—Å–µ–Ω.</div>
        </div>
        <div class="overlay-rules-row">
          <div class="icon">üíé</div>
          <div>–ö–æ–≥–¥–∞ –∫—Ä–∞—Å–Ω—ã–π –∫—Ä—É–≥ –≥–∞—Å–Ω–µ—Ç, –æ–Ω –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ <strong>–∑–µ–ª—ë–Ω—ã–π –±–æ–Ω—É—Å</strong> ‚Äî –¥–∞—ë—Ç <strong>+100 –º–æ–Ω–µ—Ç –∏ –∞–ª–º–∞–∑</strong>.</div>
        </div>
        <div class="overlay-rules-row">
          <div class="icon">‚≠ê</div>
          <div>–ö–ª–∏–∫ –ø–æ –æ–±—ã—á–Ω–æ–º—É —Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–º—É –∫—Ä—É–≥—É –ø—Ä–∏–Ω–æ—Å–∏—Ç –º–æ–Ω–µ—Ç—ã –∏ <strong>1 –∑–≤–µ–∑–¥—É</strong>.</div>
        </div>
        <div class="overlay-rules-row">
          <div class="icon">üêü</div>
          <div>–ö–∞–∂–¥—ã–µ <strong>1000 –º–æ–Ω–µ—Ç</strong> –æ—Ç–∫—Ä—ã–≤–∞—é—Ç —Ä—ã–±—É –≤ –∏–Ω–¥–µ–∫—Å–µ –∏ —É—Å–∫–æ—Ä—è—é—Ç –∏–≥—Ä—É.</div>
        </div>
        <div class="overlay-rules-row">
          <div class="icon">üíî</div>
          <div><strong>3 –ø—Ä–æ–º–∞—Ö–∞</strong> (–Ω–µ —É—Å–ø–µ–ª–∏ –Ω–∞–∂–∞—Ç—å –∏–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–µ —Ç—É–¥–∞) ‚Äî –∏–≥—Ä–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è. –†—ã–±—ã –∏ –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, —Å—á—ë—Ç –º–æ–Ω–µ—Ç –∑–∞ –∏–≥—Ä—É —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- –•–µ–ª–ø –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤–æ–π –∏–≥—Ä–æ–π -->
  <div id="helpOverlay" class="overlay-backdrop">
    <div class="overlay-card">
      <div class="overlay-title" style="margin-top:4px;">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</div>
      <div class="overlay-sub">–£—Å–ø–µ–π –Ω–∞–∂–∞—Ç—å –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫—Ä—É–≥ –∑–∞ –≤—Ä–µ–º—è —Ä–∞—É–Ω–¥–∞ –∏ —Å–æ–±–∏—Ä–∞–π –º–æ–Ω–µ—Ç—ã, –∞–ª–º–∞–∑—ã –∏ –∑–≤—ë–∑–¥—ã.</div>

      <div class="help-grid">
        <div class="help-item">
          <div class="help-circle purple">
            <span>‚≠ê</span>
          </div>
          <div class="help-caption-strong">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π –∫—Ä—É–≥</div>
          <div class="help-caption">–ù–∞–∂–∏–º–∞–π, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–Ω–µ—Ç –∏ +1 –∑–≤–µ–∑–¥—É.</div>
        </div>
        <div class="help-item">
          <div class="help-circle red">
            <span>‚ö°</span>
          </div>
          <div class="help-caption-strong">–ö—Ä–∞—Å–Ω–∞—è –±–æ–º–±–∞</div>
          <div class="help-caption">–û–ø–∞—Å–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ –≥–æ—Ä–∏—Ç (¬Ω –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞—É–Ω–¥–∞). –ù–∞–∂–º—ë—à—å —Ä–∞–Ω—å—à–µ ‚Äî –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–∏–≥—Ä—ã—à.</div>
        </div>
        <div class="help-item">
          <div class="help-circle green">
            <span>üíé</span>
          </div>
          <div class="help-caption-strong">–ó–µ–ª—ë–Ω—ã–π –±–æ–Ω—É—Å</div>
          <div class="help-caption">–ü–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –±–æ–º–±—ã ‚Äî –¥–∞—ë—Ç +100 –º–æ–Ω–µ—Ç –∏ +1 –∞–ª–º–∞–∑, –æ—à–∏–±–∫–∏ –∑–∞ –ø—Ä–æ–ø—É—Å–∫ –Ω–µ—Ç.</div>
        </div>
      </div>

      <div class="help-footer">
        –ö–∞–∂–¥—ã–µ 1000 –º–æ–Ω–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –Ω–æ–≤—É—é —Ä—ã–±—É –≤ –∏–Ω–¥–µ–∫—Å–µ —Å–ø—Ä–∞–≤–∞. –£–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ä—ã–±—ã –Ω–µ –ø—Ä–æ–ø–∞–¥–∞—é—Ç, –∞ –≤—Ä–µ–º—è —Ä–∞—É–Ω–¥–∞ –≤–Ω—É—Ç—Ä–∏ –Ω–æ–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏ –≤—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å 2 —Å–µ–∫—É–Ω–¥.
      </div>

      <div class="overlay-btn-row">
        <button id="helpOkBtn" class="primary-btn" style="margin-top:14px;">–ü–æ–Ω—è—Ç–Ω–æ</button>
      </div>
    </div>
  </div>

  <!-- –û–≤–µ—Ä–ª–µ–π "–∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞" -->
  <div id="gameOverOverlay" class="overlay-backdrop">
    <div class="overlay-card">
      <div class="overlay-icon">üèÜ</div>
      <div class="overlay-title">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</div>
      <div class="overlay-sub">–í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ –≤—Å–µ –∂–∏–∑–Ω–∏.</div>
      <div style="margin-top:10px; font-size:14px;">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</div>
      <div style="font-size:32px; font-weight:800; margin:4px 0 18px;" id="finalScore">0</div>
      <button id="restartBtn" class="primary-btn">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>
  </div>

  <!-- –û–≤–µ—Ä–ª–µ–π "–º–∏–Ω—É—Å –∂–∏–∑–Ω—å" -->
  <div id="heartOverlay" class="overlay-backdrop">
    <div class="overlay-card">
      <div class="overlay-icon">üíî</div>
      <div class="overlay-sub" style="margin-top:12px;">–í—ã –Ω–µ —É—Å–ø–µ–ª–∏ –Ω–∞–∂–∞—Ç—å –≤–æ–≤—Ä–µ–º—è ‚Äî –º–∏–Ω—É—Å –∂–∏–∑–Ω—å.</div>
      <div class="overlay-btn-row">
        <button id="continueBtn" class="primary-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Firebase init =====
    const firebaseConfig = {
      apiKey: "AIzaSyAjaFPl1f4MA5IzFxIWRZ58FvrnB5mRhGo",
      authDomain: "fast-click-fish.firebaseapp.com",
      projectId: "fast-click-fish",
      storageBucket: "fast-click-fish.firebasestorage.app",
      messagingSenderId: "1056500535536",
      appId: "1:1056500535536:web:17072be3e0150bdf57f235",
      measurementId: "G-V05JPW6BM1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const LEADERBOARD_COLLECTION = "fast_click_leaderboard";

    // ===== –û–±–ª–∞—á–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ Firestore =====

    async function pushRunToCloud(row) {
      try {
        await db.collection(LEADERBOARD_COLLECTION).add({
          name: row.name || "–ò–≥—Ä–æ–∫",
          fish: row.totalFish || 0,
          time: row.time || 0,
          coins: row.totalCoins || 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Firestore", e);
      }
    }

    async function loadCloudLeaderboard() {
      try {
        const snap = await db.collection(LEADERBOARD_COLLECTION)
          .orderBy("fish", "desc")
          .orderBy("time", "asc")
          .limit(100)
          .get();

        const rows = [];
        snap.forEach(doc => {
          const d = doc.data();
          rows.push({
            name: d.name || "–ò–≥—Ä–æ–∫",
            totalFish: d.fish || 0,
            time: d.time || 0,
            totalCoins: d.coins || 0
          });
        });

        renderLeaderboard(rows);
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –∏–∑ Firestore", e);
      }
    }

    // ===== –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã =====

    const FISH_TOTAL = 21;
    const BASE_TIME = 2.0;
    const TIME_STEP = 0.1;
    const MIN_TIME = 0.5;
    const STORAGE_KEY = "fastClickFishState_v1";

    let score = 0;
    let totalCoinsAll = 0;

    let diamondsRun = 0;
    let diamondsAll = 0;

    let starsRun = 0;
    let starsAll = 0;

    let fishUnlocked = 0; // —Å–∫–æ–ª—å–∫–æ —Ä—ã–± –æ—Ç–∫—Ä—ã—Ç–æ –≤—Å–µ–≥–æ
    let lives = 3;

    let currentRoundTime = BASE_TIME;
    let currentCircleIndex = -1;
    let isBombRound = false;
    let roundStartTs = 0;
    let roundEndTs = 0;
    let bombEndTs = 0;

    let timerInterval = null;
    let gameRunning = false;
    let gamePaused = true;

    let nickname = "–ò–≥—Ä–æ–∫";

    // DOM-—Å—Å—ã–ª–∫–∏
    const scoreCurrentEl = document.getElementById("scoreCurrent");
    const coinsAllMainEl = document.getElementById("coinsAllMain");
    const coinsRunTopEl = document.getElementById("coinsRunTop");

    const diamondsAllMainEl = document.getElementById("diamondsAllMain");
    const diamondsRunTopEl = document.getElementById("diamondsRunTop");
    const diamondsRunInlineEl = document.getElementById("diamondsRunInline");

    const starsAllMainEl = document.getElementById("starsAllMain");
    const starsRunTopEl = document.getElementById("starsRunTop");
    const starsRunInlineEl = document.getElementById("starsRunInline");

    const timerLabelEl = document.getElementById("timerLabel");
    const timerFillEl = document.getElementById("timerFill");
    const heartsPanelEl = document.getElementById("heartsPanel");
    const startBtn = document.getElementById("startBtn");
    const rulesLink = document.getElementById("rulesLink");

    const nicknameInput = document.getElementById("nicknameInput");
    const nicknameOkBtn = document.getElementById("nicknameOkBtn");

    const levelValueEl = document.getElementById("levelValue");
    const fishProgressFillEl = document.getElementById("fishProgressFill");
    const fishGridEl = document.getElementById("fishGrid");

    const rulesOverlay = document.getElementById("rulesOverlay");
    const rulesPlayBtn = document.getElementById("rulesPlayBtn");
    const helpOverlay = document.getElementById("helpOverlay");
    const helpOkBtn = document.getElementById("helpOkBtn");

    const gameOverOverlay = document.getElementById("gameOverOverlay");
    const finalScoreEl = document.getElementById("finalScore");
    const restartBtn = document.getElementById("restartBtn");

    const heartOverlay = document.getElementById("heartOverlay");
    const continueBtn = document.getElementById("continueBtn");

    const leaderboardRowsEl = document.getElementById("leaderboardRows");
    const myBestInfoEl = document.getElementById("myBestInfo");

    const circles = Array.from(document.querySelectorAll(".circle-btn"));

    // ===== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ =====

    function formatNum(n) {
      return n.toLocaleString("ru-RU");
    }

    function clamp(v, min, max) {
      return v < min ? min : v > max ? max : v;
    }

    function saveState() {
      const data = {
        totalCoinsAll,
        diamondsAll,
        starsAll,
        fishUnlocked,
        nickname
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (typeof data.totalCoinsAll === "number") totalCoinsAll = data.totalCoinsAll;
        if (typeof data.diamondsAll === "number") diamondsAll = data.diamondsAll;
        if (typeof data.starsAll === "number") starsAll = data.starsAll;
        if (typeof data.fishUnlocked === "number") fishUnlocked = data.fishUnlocked;
        if (typeof data.nickname === "string") nickname = data.nickname;
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ", e);
      }
    }

    function updateTimerLabel() {
      timerLabelEl.textContent = currentRoundTime.toFixed(1) + " c";
    }

    function updateHeartsUI() {
      heartsPanelEl.innerHTML = "";
      for (let i = 0; i < 3; i++) {
        const span = document.createElement("span");
        if (i < lives) {
          span.className = "heart-full";
          span.textContent = "‚ù§Ô∏è";
        } else {
          span.className = "heart-empty";
          span.textContent = "‚ù§Ô∏è";
        }
        heartsPanelEl.appendChild(span);
      }
    }

    function updateScoreUI() {
      scoreCurrentEl.textContent = formatNum(score);

      coinsAllMainEl.textContent = formatNum(totalCoinsAll);
      coinsRunTopEl.textContent = formatNum(score);

      diamondsAllMainEl.textContent = formatNum(diamondsAll);
      diamondsRunTopEl.textContent = formatNum(diamondsRun);
      diamondsRunInlineEl.textContent = formatNum(diamondsRun);

      starsAllMainEl.textContent = formatNum(starsAll);
      starsRunTopEl.textContent = formatNum(starsRun);
      starsRunInlineEl.textContent = formatNum(starsRun);
    }

    const fishDefs = [
      "–†—ã–±–∞-–∫–ª–æ—É–Ω", "–ì–ª—É–±–∏–Ω–Ω—ã–π —É–≥–æ—Ä—å", "–õ–µ–¥—è–Ω–æ–π –æ–∫—É–Ω—å",
      "–õ—É–Ω–Ω–∞—è —Ä—ã–±–∞", "–ù–µ–æ–Ω–æ–≤—ã–π –∞–Ω–≥–µ–ª", "–ü–∏—Ä–∞–Ω—å—è –∏–∑ –≥–ª—É–±–∏–Ω",
      "–õ–æ—Å–æ—Å—å", "–õ—è–≥—É—à–∫–∞", "–°–µ—Ä–µ–±—Ä—è–Ω—ã–π —Ç—É–Ω–µ—Ü",
      "–ì–∏–≥–∞–Ω—Ç—Å–∫–∏–π –∫—Ä–∞–±", "–ö–∞–º–µ–Ω–Ω–∞—è —Ä—ã–±–∞", "–ó–µ–±—Ä–∞-–∑–º–µ–π–∫–∞",
      "–í–æ–¥—è–Ω–∞—è –∑–º–µ—è", "–ú–æ—Ä—Å–∫–∞—è —É–ª–∏—Ç–∫–∞", "–ö–æ—à–∞—á—å—è —Ä—ã–±–∞",
      "–ë–∞—Ä—Ä–∞–∫—É–¥–∞", "–•—Ä–∞–Ω–∏—Ç–µ–ª—å —Ä–∏—Ñ–∞", "–õ–∞–≤–æ–≤—ã–π –æ–∫—É–Ω—å",
      "–ö—Ä–æ–∫–æ–¥–∏–ª", "–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫—Ä–µ–≤–µ—Ç–∫–∞", "–ê–Ω—Ç–∏–∫–≤–∞—Ä–Ω—ã–π –∫—É–±–æ–∫"
    ];

    function buildFishGrid() {
      fishGridEl.innerHTML = "";
      for (let i = 0; i < FISH_TOTAL; i++) {
        const cell = document.createElement("div");
        cell.className = "fish-cell locked";
        const iconWrap = document.createElement("div");
        iconWrap.className = "fish-icon-wrapper";
        const icon = document.createElement("span");
        icon.textContent = "üêü";
        iconWrap.appendChild(icon);
        const name = document.createElement("div");
        name.className = "fish-name";
        name.textContent = fishDefs[i] || "???";
        const cost = document.createElement("div");
        cost.className = "fish-cost";
        cost.textContent = (i + 1) * 1000 + " –º–æ–Ω–µ—Ç";

        cell.appendChild(iconWrap);
        cell.appendChild(name);
        cell.appendChild(cost);
        fishGridEl.appendChild(cell);
      }
      updateFishUI();
    }

    function updateFishUI() {
      const cells = Array.from(fishGridEl.children);
      cells.forEach((cell, idx) => {
        cell.classList.remove("unlocked");
        cell.classList.add("locked");
        const badge = cell.querySelector(".fish-unlock-badge");
        if (badge) badge.remove();
        if (idx < fishUnlocked) {
          cell.classList.remove("locked");
          cell.classList.add("unlocked");
          const b = document.createElement("div");
          b.className = "fish-unlock-badge";
          b.textContent = "–ü–æ–ª—É—á–µ–Ω–∞";
          cell.appendChild(b);
        }
      });

      levelValueEl.textContent = fishUnlocked + " / " + FISH_TOTAL;
      const progress = (fishUnlocked / FISH_TOTAL) * 100;
      fishProgressFillEl.style.width = progress + "%";
      currentRoundTime = Math.max(MIN_TIME, BASE_TIME - fishUnlocked * TIME_STEP);
      updateTimerLabel();
    }

    function setCirclesDisabledAll() {
      circles.forEach(btn => {
        btn.classList.add("disabled");
        btn.classList.remove("active-purple", "active-bomb", "active-green");
      });
    }

    function chooseNextRound() {
      currentCircleIndex = Math.floor(Math.random() * circles.length);
      isBombRound = Math.random() < 0.22;
      roundStartTs = performance.now();
      roundEndTs = roundStartTs + currentRoundTime * 1000;
      bombEndTs = isBombRound ? roundStartTs + currentRoundTime * 500 : 0;

      circles.forEach((btn, idx) => {
        btn.classList.remove("active-purple", "active-bomb", "active-green");
        btn.classList.add("disabled");
        const iconSpan = btn.querySelector(".circle-icon");
        iconSpan.textContent = "‚ö°";
      });

      const active = circles[currentCircleIndex];
      active.classList.remove("disabled");
      const iconSpan = active.querySelector(".circle-icon");

      if (isBombRound) {
        active.classList.add("active-bomb");
        iconSpan.textContent = "‚ö°"; // –º–æ–ª–Ω–∏—è –Ω–∞ –∫—Ä–∞—Å–Ω–æ–π
      } else {
        active.classList.add("active-purple");
        iconSpan.textContent = "‚≠ê"; // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π ‚Äî –∑–≤–µ–∑–¥–∞
      }

      if (timerInterval) clearInterval(timerInterval);
      timerFillEl.style.transform = "scaleX(1)";

      timerInterval = setInterval(() => {
        const now = performance.now();
        const total = roundEndTs - roundStartTs;
        const left = roundEndTs - now;
        const frac = clamp(left / total, 0, 1);
        timerFillEl.style.transform = "scaleX(" + frac + ")";

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–æ–º–±—ã –≤ –∑–µ–ª—ë–Ω—ã–π –±–æ–Ω—É—Å
        if (isBombRound && now >= bombEndTs && !active.classList.contains("active-green")) {
          active.classList.remove("active-bomb");
          active.classList.add("active-green");
          const span = active.querySelector(".circle-icon");
          span.textContent = "üíé"; // –∑–µ–ª—ë–Ω—ã–π ‚Äî –∞–ª–º–∞–∑
        }

        if (left <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          onRoundTimeout();
        }
      }, 30);
    }

    function onRoundTimeout() {
      // –µ—Å–ª–∏ –±—ã–ª —Ä–∞—É–Ω–¥ —Å –±–æ–º–±–æ–π ‚Äî –ø—Ä–æ–ø—É—Å–∫ –±–µ–∑–æ–ø–∞—Å–µ–Ω
      if (!isBombRound) {
        missLife();
      } else {
        // –±–æ–º–±–∞/–∑–µ–ª—ë–Ω—ã–π, –ø—Ä–æ–ø—É—Å–∫ –Ω–µ —à—Ç—Ä–∞—Ñ—É–µ—Ç—Å—è
        if (gameRunning) {
          chooseNextRound();
        }
      }
    }

    function missLife() {
      gameRunning = false;
      gamePaused = true;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      lives = Math.max(0, lives - 1);
      updateHeartsUI();

      if (lives <= 0) {
        // —Ñ–∏–Ω–∞–ª
        endRun();
      } else {
        showHeartOverlay();
      }
    }

    function showHeartOverlay() {
      heartOverlay.style.display = "flex";
    }

    function hideHeartOverlay() {
      heartOverlay.style.display = "none";
    }

    function showGameOverOverlay() {
      gameOverOverlay.style.display = "flex";
    }

    function hideGameOverOverlay() {
      gameOverOverlay.style.display = "none";
    }

    function showRulesOverlay(initial) {
      rulesOverlay.style.display = "flex";
      if (initial) {
        // –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
      }
    }

    function hideRulesOverlay() {
      rulesOverlay.style.display = "none";
    }

    function showHelpOverlay() {
      helpOverlay.style.display = "flex";
    }

    function hideHelpOverlay() {
      helpOverlay.style.display = "none";
    }

    function resetRun() {
      score = 0;
      diamondsRun = 0;
      starsRun = 0;
      lives = 3;
      gameRunning = false;
      gamePaused = true;
      updateHeartsUI();
      updateScoreUI();
      updateFishUI();
      setCirclesDisabledAll();
      startBtn.textContent = "–ò–≥—Ä–∞—Ç—å";
    }

    function startRun() {
      if (!nickname || nickname.trim() === "") {
        nickname = "–ò–≥—Ä–æ–∫";
        nicknameInput.value = nickname;
      }
      if (lives <= 0) {
        resetRun();
      }
      hideHeartOverlay();
      hideGameOverOverlay();
      hideRulesOverlay();

      gameRunning = true;
      gamePaused = false;
      startBtn.textContent = "–ü–∞—É–∑–∞";
      chooseNextRound();
    }

    function pauseRun() {
      gameRunning = false;
      gamePaused = true;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      setCirclesDisabledAll();
      startBtn.textContent = "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å";
    }

    function handleCircleClick(idx) {
      if (!gameRunning || gamePaused) return;

      if (idx !== currentCircleIndex) {
        missLife();
        return;
      }

      const now = performance.now();
      if (isBombRound && now < bombEndTs) {
        // –∫–ª–∏–∫ –ø–æ –∫—Ä–∞—Å–Ω–æ–π –±–æ–º–±–µ ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–∏–≥—Ä—ã—à
        lives = 0;
        updateHeartsUI();
        endRun();
        return;
      }

      // –∑–µ–ª—ë–Ω—ã–π –±–æ–Ω—É—Å –∏–ª–∏ —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π –∫—Ä—É–≥
      if (isBombRound && now >= bombEndTs) {
        // –∑–µ–ª—ë–Ω—ã–π
        score += 100;
        diamondsRun += 1;
        diamondsAll += 1;
      } else {
        // –æ–±—ã—á–Ω—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
        const gain = 60 + Math.floor(Math.random() * 90); // 60‚Äì150
        score += gain;
        starsRun += 1;
        starsAll += 1;
      }

      totalCoinsAll += 0; // –æ–±—â–∏–π —Å—á—ë—Ç –º–æ–Ω–µ—Ç –∑–∞ –≤—Å–µ –∏–≥—Ä—ã –º–æ–∂–Ω–æ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å = score; –æ—Å—Ç–∞–≤–∏–º –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–º endRun
      updateScoreUI();

      // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Ä—ã–±
      while (fishUnlocked < FISH_TOTAL && score >= (fishUnlocked + 1) * 1000) {
        fishUnlocked++;
      }
      updateFishUI();
      saveState();

      // —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      if (gameRunning) {
        chooseNextRound();
      }
    }

    function endRun() {
      gameRunning = false;
      gamePaused = true;
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      setCirclesDisabledAll();
      startBtn.textContent = "–ò–≥—Ä–∞—Ç—å";

      totalCoinsAll += score;
      saveState();
      updateScoreUI();

      // –ø—É—à–∏–º –≤ –æ–±–ª–∞–∫–æ
      const totalFish = fishUnlocked;
      const time = (BASE_TIME - currentRoundTime + 2) * 10; // –≥—Ä—É–±–∞—è –æ—Ü–µ–Ω–∫–∞
      const row = {
        name: nickname || "–ò–≥—Ä–æ–∫",
        totalFish,
        time,
        totalCoins: totalCoinsAll
      };
      pushRunToCloud(row);
      loadCloudLeaderboard(); // –æ–±–Ω–æ–≤–∏–º —Ç–æ–ø

      finalScoreEl.textContent = formatNum(score);
      showGameOverOverlay();
    }

    // ===== –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ =====

    function renderLeaderboard(rows) {
      leaderboardRowsEl.innerHTML = "";

      const nicknameLower = (nickname || "").toLowerCase();
      let myBest = null;

      rows.forEach((row, index) => {
        const div = document.createElement("div");
        div.className = "lb-row rank-default";

        if (index === 0) div.className = "lb-row rank-1";
        else if (index === 1) div.className = "lb-row rank-2";
        else if (index === 2) div.className = "lb-row rank-3";

        const r = document.createElement("div");
        r.className = "lb-rank";
        r.textContent = index + 1;

        const n = document.createElement("div");
        n.className = "lb-name";
        n.textContent = row.name || "–ò–≥—Ä–æ–∫";

        const f = document.createElement("div");
        f.className = "lb-fish";
        f.textContent = row.totalFish ?? 0;

        const t = document.createElement("div");
        t.className = "lb-time";
        t.textContent = (row.time ?? 0).toFixed ? row.time.toFixed(1) + " c" : row.time + " c";

        div.appendChild(r);
        div.appendChild(n);
        div.appendChild(f);
        div.appendChild(t);
        leaderboardRowsEl.appendChild(div);

        if (row.name && row.name.toLowerCase() === nicknameLower) {
          if (!myBest || (row.totalFish > myBest.totalFish) ||
              (row.totalFish === myBest.totalFish && row.time < myBest.time)) {
            myBest = row;
          }
        }
      });

      if (!rows.length) {
        leaderboardRowsEl.innerHTML = "<div style='padding:10px;font-size:12px;opacity:0.8;'>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>";
      }

      if (myBest) {
        myBestInfoEl.textContent =
          myBest.name + " ‚Äî " +
          myBest.totalFish + " —Ä—ã–±, " +
          (myBest.time.toFixed ? myBest.time.toFixed(1) : myBest.time) + " c";
      } else {
        myBestInfoEl.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.";
      }
    }

    // ===== –ù–∏–∫–Ω–µ–π–º =====

    function applyNicknameToInput() {
      nicknameInput.value = nickname;
    }

    nicknameInput.addEventListener("input", () => {
      nicknameOkBtn.style.display = "inline-block";
    });

    nicknameInput.addEventListener("focus", () => {
      nicknameOkBtn.style.display = "inline-block";
    });

    nicknameOkBtn.addEventListener("click", () => {
      const value = nicknameInput.value.trim();
      nickname = value || "–ò–≥—Ä–æ–∫";
      nicknameInput.value = nickname;
      nicknameOkBtn.style.display = "none";
      saveState();
      loadCloudLeaderboard();
    });

    // ===== –°–æ–±—ã—Ç–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ =====

    startBtn.addEventListener("click", () => {
      if (!gameRunning && gamePaused && lives === 3 && score === 0) {
        // –Ω–æ–≤–∞—è –∏–≥—Ä–∞
        startRun();
      } else if (gameRunning && !gamePaused) {
        pauseRun();
      } else {
        // –ø–∞—É–∑–∞ -> –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        startRun();
      }
    });

    rulesLink.addEventListener("click", () => {
      showRulesOverlay(false);
    });

    rulesPlayBtn.addEventListener("click", () => {
      hideRulesOverlay();
      startRun();
    });

    helpOkBtn.addEventListener("click", () => {
      hideHelpOverlay();
      showRulesOverlay(true);
    });

    restartBtn.addEventListener("click", () => {
      hideGameOverOverlay();
      resetRun();
    });

    continueBtn.addEventListener("click", () => {
      hideHeartOverlay();
      startRun();
    });

    circles.forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.getAttribute("data-index"));
        handleCircleClick(idx);
      });
    });

    // ===== –°—Ç–∞—Ä—Ç =====

    function init() {
      loadState();
      updateScoreUI();
      updateHeartsUI();
      buildFishGrid();
      applyNicknameToInput();
      updateFishUI();
      updateTimerLabel();
      setCirclesDisabledAll();

      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º help –ø—Ä–∏ —Å–∞–º–æ–º –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
      const seenHelpKey = "fastClickFish_seenHelp";
      const seen = localStorage.getItem(seenHelpKey);
      if (!seen) {
        showHelpOverlay();
        localStorage.setItem(seenHelpKey, "1");
      }

      loadCloudLeaderboard();
    }

    init();
  </script>
</body>
</html>
