<script>
  // ==== Firebase init (online leaderboard) ====
  const firebaseConfig = {
    apiKey: "AIzaSyAjaFPl1f4MA5IzFxIWRZ58FvrnB5mRhGo",
    authDomain: "fast-click-fish.firebaseapp.com",
    projectId: "fast-click-fish",
    storageBucket: "fast-click-fish.firebasestorage.app",
    messagingSenderId: "1056500535536",
    appId: "1:1056500535536:web:17072be3e0150bdf57f235",
    measurementId: "G-V05JPW6BM1"
  };

  try {
    firebase.initializeApp(firebaseConfig);
  } catch (e) {
    console.warn("Firebase init error (maybe already initialized):", e);
  }
  const db = firebase.firestore();
  const LEADERBOARD_COLLECTION = "fast_click_leaderboard";
  let cloudLeaderboard = [];

  async function pushRunToCloud(row) {
    try {
      await db.collection(LEADERBOARD_COLLECTION).add({
        name: row.name || "–ò–≥—Ä–æ–∫",
        fishGained: row.fishGained || 0,
        totalFish: row.totalFish || 0,
        time: row.time || 0,
        score: row.score || 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Firestore", e);
    }
  }

  async function loadCloudLeaderboard() {
    try {
      const snap = await db.collection(LEADERBOARD_COLLECTION)
        .orderBy("fishGained", "desc")
        .orderBy("score", "desc")
        .orderBy("time", "asc")
        .limit(100)
        .get();

      cloudLeaderboard = [];
      snap.forEach(doc => {
        const d = doc.data();
        cloudLeaderboard.push({
          name: d.name || "–ò–≥—Ä–æ–∫",
          fishGained: d.fishGained || 0,
          totalFish: d.totalFish || 0,
          time: d.time || 0,
          score: d.score || 0
        });
      });

      renderLeaderboard(cloudLeaderboard);
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–Ω–ª–∞–π–Ω-–ª–∏–¥–µ—Ä–±–æ—Ä–¥ –∏–∑ Firestore", e);
      renderLeaderboard(loadLeaderboard());
    }
  }

  const MAX_MISSES = 3;
  const BASE_ROUND_TIME_MS = 2000;
  const MIN_ROUND_TIME_MS = 500;

  const circles = Array.from(document.querySelectorAll('.circle'));
  const scoreEl = document.getElementById('score');
  const messageEl = document.getElementById('message');
  const timerFill = document.getElementById('timerFill');
  const startBtn = document.getElementById('startBtn');
  const rulesBtn = document.getElementById('rulesBtn');
  const heartsView = document.getElementById('heartsView');
  const roundTimeLabel = document.getElementById('roundTimeLabel');

  const gameOverOverlay = document.getElementById('gameOverOverlay');
  const overlayTitle = document.getElementById('overlayTitle');
  const overlaySub = document.getElementById('overlaySub');
  const overlayScore = document.getElementById('overlayScore');
  const overlayResultLabel = document.getElementById('overlayResultLabel');
  const playAgainBtn = document.getElementById('playAgainBtn');

  const helpOverlay = document.getElementById('helpOverlay');
  const helpCloseBtn = document.getElementById('helpCloseBtn');

  const heartOverlay = document.getElementById('heartOverlay');

  const fishGrid = document.getElementById('fishGrid');
  const fishProgressText = document.getElementById('fishProgressText');
  const fishProgressFill = document.getElementById('fishProgressFill');

  const playerNameInput = document.getElementById('playerNameInput');
  const saveNameBtn = document.getElementById('saveNameBtn');
  const leaderboardBody = document.getElementById('leaderboardBody');
  const myBestBlock = document.getElementById('myBestBlock');

  const coinsRunEl = document.getElementById('coinsRun');
  const coinsTotalEl = document.getElementById('coinsTotal');
  const diamondsRunEl = document.getElementById('diamondsRun');
  const diamondsTotalEl = document.getElementById('diamondsTotal');
  const starsRunEl = document.getElementById('starsRun');
  const starsTotalEl = document.getElementById('starsTotal');

  const fishList = [
    { name: '–†—ã–±–∞-–∫–ª–æ—É–Ω', emoji: 'üê†' },
    { name: '–ì–ª—É–±–∏–Ω–Ω—ã–π —É–≥–æ—Ä—å', emoji: 'üêç' },
    { name: '–õ–µ–¥—è–Ω–æ–π –æ–∫—É–Ω—å', emoji: 'üêü' },
    { name: '–õ—É–Ω–Ω–∞—è —Ä—ã–±–∞', emoji: 'üåï' },
    { name: '–ù–µ–æ–Ω–æ–≤—ã–π –∞–Ω–≥–µ–ª', emoji: '‚ú®' },
    { name: '–ü–∏—Ä–∞–Ω—å—è –∏–∑ –≥–ª—É–±–∏–Ω', emoji: 'ü¶à' },
    { name: '–ú–µ–¥—É–∑–∞-–ø—Ä–∏–∑—Ä–∞–∫', emoji: 'ü™º' },
    { name: '–ö–∞–º–µ–Ω–Ω—ã–π –±–∞—Å–ª–µ—Ç', emoji: 'ü™®' },
    { name: '–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π —Å–æ–º', emoji: 'üíé' },
    { name: '–õ—è–≥—É—à–∫–∞-–¥–∞–π–≤–µ—Ä', emoji: 'üê∏' },
    { name: '–ö—Ä–∞–±-–≥–∏–≥–∞–Ω—Ç', emoji: 'ü¶Ä' },
    { name: '–î—Ä–∞–∫–æ–Ω—å—è —Ä—ã–±–∞', emoji: 'üêâ' },
    { name: '–°–≤–µ—Ç—è—â–∏–π—Å—è –∫–∞—Ä–ø', emoji: 'üêü' },
    { name: '–≠–ª–µ–∫—Ç—Ä–æ-—Å–µ–ª—å–¥—å', emoji: '‚ö°' },
    { name: '–†–∞–¥—É–∂–Ω—ã–π –ª–æ—Å–æ—Å—å', emoji: 'üê°' },
    { name: '–ó–æ–ª–æ—Ç–æ–π —É–≥–æ—Ä—å', emoji: 'üêç' },
    { name: '–ö–æ—Ä–∞–ª–ª–æ–≤—ã–π –±—ã—á–æ–∫', emoji: 'üê†' },
    { name: '–¢–µ–Ω–µ–≤–æ–π —Å–∫–∞—Ç', emoji: 'ü¶Ç' },
    { name: '–§–æ—Å—Ñ–æ—Ä–Ω—ã–π –æ–∫—É–Ω—å', emoji: 'üí°' },
    { name: '–ú–æ—Ä—Å–∫–æ–π –¥—Ä–∞–∫–æ–Ω', emoji: 'üê≤' },
    { name: '–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Ä—ã–±–∞', emoji: 'üõ∏' }
  ];
  fishList.forEach((fish, i)=> fish.requiredScore=(i+1)*1000);

  function formatNum(n){
    return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
  }

  // –§–∏–æ–ª–µ—Ç–æ–≤–∞—è –Ω–∞–≥—Ä–∞–¥–∞ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏: 50 ‚Üí 1
  function calcPurpleReward() {
    if (!roundDurationMs) return 1;
    const elapsed = performance.now() - roundStartPerf;
    const remaining = Math.max(0, roundDurationMs - elapsed);
    const timePerPoint = roundDurationMs / 50;
    let points = Math.round(remaining / timePerPoint);
    if (points < 1) points = 1;
    if (points > 50) points = 50;
    return points;
  }

  let score = 0;            // –º–æ–Ω–µ—Ç—ã –∑–∞ —Ç–µ–∫—É—â—É—é –∏–≥—Ä—É
  let misses = 0;
  let activeIndex = null;

  let bombRound = false;
  let bombDangerIndex = null;
  let greenBonusIndex = null;
  let yellowIndex = null;
  let isYellowPhase = false;

  let rewards = [0,0,0];
  let timerId = null;
  let roundActive = false;

  let unlockedFish = 0;
  let currentRoundTimeMs = BASE_ROUND_TIME_MS;

  let runStartTimeMs = 0;
  let runStartUnlockedFish = 0;
  let runFishGained = 0;

  let roundStartPerf = 0;
  let roundDurationMs = 0;

  let fishSlots = [];
  let playerName = '';
  let helpSeen = false;
  let pendingContinue = false;
  let overlayMode = null;

  // –∞–ª–º–∞–∑—ã / –∑–≤—ë–∑–¥—ã –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏
  let diamondsRun = 0;
  let starsRun = 0;
  let totalCoinsAll = 0;
  let totalDiamondsAll = 0;
  let totalStarsAll = 0;

  function updateStatsUI(){
    coinsRunEl.textContent = formatNum(totalCoinsAll);
    coinsTotalEl.textContent = formatNum(score);
    diamondsRunEl.textContent = formatNum(totalDiamondsAll);
    diamondsTotalEl.textContent = formatNum(diamondsRun);
    starsRunEl.textContent = formatNum(totalStarsAll);
    starsTotalEl.textContent = formatNum(starsRun);
    const dRunGame = document.getElementById('diamondsRunGame');
    const sRunGame = document.getElementById('starsRunGame');
    if(dRunGame) dRunGame.textContent = formatNum(diamondsRun);
    if(sRunGame) sRunGame.textContent = formatNum(starsRun);
    scoreEl.textContent = formatNum(score);
  }

  function loadTotals(){
    try{
      totalCoinsAll = Number(localStorage.getItem('fastClick_totalCoins')||'0');
      totalDiamondsAll = Number(localStorage.getItem('fastClick_totalDiamonds')||'0');
      totalStarsAll = Number(localStorage.getItem('fastClick_totalStars')||'0');
    }catch(e){}
    updateStatsUI();
  }
  function saveTotals(){
    try{
      localStorage.setItem('fastClick_totalCoins', String(totalCoinsAll));
      localStorage.setItem('fastClick_totalDiamonds', String(totalDiamondsAll));
      localStorage.setItem('fastClick_totalStars', String(totalStarsAll));
    }catch(e){}
  }

  function buildFishGrid(){
    fishGrid.innerHTML='';
    fishSlots = [];
    fishList.forEach((fish,index)=>{
      const slot=document.createElement('div');
      slot.className='fish-slot';
      slot.dataset.fishIndex=index;
      slot.innerHTML=`
        <div class="fish-emoji">${fish.emoji}</div>
        <div class="fish-name">${fish.name}</div>
        <div class="fish-req">${formatNum(fish.requiredScore)} –º–æ–Ω–µ—Ç</div>`;
      fishGrid.appendChild(slot);
      fishSlots.push({slot});
    });
    updateFishProgress();
  }

  function updateFishProgress(){
    const total = fishList.length;
    fishProgressText.textContent = unlockedFish + ' / ' + total;
    const ratio = total === 0 ? 0 : unlockedFish / total;
    fishProgressFill.style.width = (ratio * 100) + '%';

    fishSlots.forEach((fs, index)=>{
      if(index < unlockedFish){
        fs.slot.classList.add('unlocked');
      } else {
        fs.slot.classList.remove('unlocked');
      }
    });
  }

  function tryUnlockFish(){
    const possible = Math.min(Math.floor(score / 1000), fishList.length);
    if(possible > unlockedFish){
      const newly = possible - unlockedFish;
      for(let i = unlockedFish; i < possible; i++){
        const fs = fishSlots[i];
        if(!fs) continue;
        fs.slot.classList.add('unlocked','just-unlocked');
        setTimeout(()=>fs.slot.classList.remove('just-unlocked'), 700);
      }
      unlockedFish = possible;
      runFishGained = unlockedFish - runStartUnlockedFish;

      currentRoundTimeMs = Math.max(MIN_ROUND_TIME_MS, currentRoundTimeMs - newly * 100);
      roundTimeLabel.textContent = (currentRoundTimeMs/1000).toFixed(1) + ' c';

      updateFishProgress();
    }
  }

  function updateHearts(){
    const heartsCount = MAX_MISSES;
    const activeHearts = heartsCount - misses;
    let html='';
    for(let i=0;i<activeHearts;i++) html+='<span class="heart-full">‚ù§Ô∏è</span>';
    for(let i=0;i<misses;i++) html+='<span class="heart-empty">‚ù§</span>';
    heartsView.innerHTML = html;
  }

  function resetUI(){
    circles.forEach(c=>{
      c.classList.remove('active','bomb-visible','green-bonus','yellow-bonus');
      const icon = c.querySelector('.circle-icon');
      if(icon) icon.textContent = '‚ö°';
      c.style.visibility = 'visible';
    });
    timerFill.style.transform='scaleX(0)';
    messageEl.textContent='';
    updateHearts();
    pendingContinue = false;
    startBtn.textContent = '–ò–≥—Ä–∞—Ç—å';
    heartOverlay.classList.remove('visible');

    bombRound = false;
    bombDangerIndex = null;
    greenBonusIndex = null;
    yellowIndex = null;
    isYellowPhase = false;
  }

  function showRewardPopup(circleEl, text){
    const popup=document.createElement('div');
    popup.className='reward-popup';
    popup.textContent=text;
    circleEl.appendChild(popup);
    setTimeout(()=>popup.remove(),700);
    scoreEl.classList.add('bump');
    setTimeout(()=>scoreEl.classList.remove('bump'),180);
  }

  function loadPlayerName(){
    try{
      const saved = localStorage.getItem('fastClickPlayerName');
      if(saved){
        playerName = saved;
        playerNameInput.value = saved;
        playerNameInput.readOnly = true;
        saveNameBtn.style.display = 'none';
      } else {
        playerNameInput.readOnly = false;
        saveNameBtn.style.display = 'inline-block';
      }
    }catch(e){
      playerNameInput.readOnly = false;
    }
  }

  function savePlayerName(){
    playerName = playerNameInput.value.trim() || '–ò–≥—Ä–æ–∫';
    try{
      localStorage.setItem('fastClickPlayerName', playerName);
    }catch(e){}
    playerNameInput.value = playerName;
    playerNameInput.readOnly = true;
    saveNameBtn.style.display = 'none';
    renderLeaderboard(cloudLeaderboard.length ? cloudLeaderboard : loadLeaderboard());
  }

  function loadLeaderboard(){
    try{
      const raw = localStorage.getItem('fastClickLeaderboard');
      if(!raw) return [];
      return JSON.parse(raw);
    }catch(e){ return []; }
  }

  function saveLeaderboard(data){
    try{
      localStorage.setItem('fastClickLeaderboard', JSON.stringify(data));
    }catch(e){}
  }

  function formatTime(sec){
    const totalMs = Math.round(sec*1000);
    const s = Math.floor(totalMs/1000);
    const ms = Math.floor((totalMs%1000)/100);
    const m = Math.floor(s/60);
    const s2 = s%60;
    return `${String(m).padStart(2,'0')}:${String(s2).padStart(2,'0')}.${ms}`;
  }

  function renderMyBest(data){
    if(!myBestBlock) return;
    let best = null;
    const nameToUse = playerName || playerNameInput.value.trim() || '–ò–≥—Ä–æ–∫';
    data.forEach(row=>{
      if(row.name !== nameToUse) return;
      if(!best){
        best = row;
      } else {
        if(row.fishGained > best.fishGained ||
           (row.fishGained === best.fishGained && row.time < best.time)){
          best = row;
        }
      }
    });

    if(!best){
      myBestBlock.innerHTML = `
        <div class="leaderboard-mybest-title">–ú–æ–π –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <div class="leaderboard-mybest-row">
          <span>–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</span>
        </div>`;
    } else {
      myBestBlock.innerHTML = `
        <div class="leaderboard-mybest-title">–ú–æ–π –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
        <div class="leaderboard-mybest-row">
          <span style="font-size:13px;">–†—ã–± –≤—Å–µ–≥–æ: <b style="font-size:16px;">${best.totalFish}</b></span>
          <span style="font-size:13px;">–í—Ä–µ–º—è: <b style="font-size:16px;">${formatTime(best.time)}</b></span>
        </div>`;
    }
  }

  function renderLeaderboard(data){
    const rows = data || [];
    leaderboardBody.innerHTML = '';

    rows.forEach((row, idx) => {
      let rowClass = '';
      if (idx === 0) rowClass = 'gold-row';
      else if (idx === 1) rowClass = 'silver-row';
      else if (idx === 2) rowClass = 'bronze-row';
      else rowClass = 'lb-other';

      const tr = document.createElement('tr');
      tr.className = rowClass;
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${row.name}</td>
        <td>${row.totalFish}</td>
        <td>${formatTime(row.time)}</td>`;
      leaderboardBody.appendChild(tr);
    });

    renderMyBest(rows);
  }

  function addResultToLeaderboard(){
    const durationSec = (Date.now() - runStartTimeMs) / 1000;
    const nameToUse = playerName || playerNameInput.value.trim() || '–ò–≥—Ä–æ–∫';

    const entry = {
      name: nameToUse,
      fishGained: runFishGained,
      totalFish: unlockedFish,
      time: durationSec,
      score: score
    };

    // –≤ Firestore
    pushRunToCloud(entry);

    // –ª–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è "–æ–±–ª–∞–∫–∞"
    let data = cloudLeaderboard ? cloudLeaderboard.slice() : [];
    data.push(entry);

    data.sort((a, b) => {
      if (b.fishGained !== a.fishGained) return b.fishGained - a.fishGained;
      if (b.score !== a.score) return b.score - a.score;
      return a.time - b.time;
    });

    cloudLeaderboard = data.slice(0, 100);
    renderLeaderboard(cloudLeaderboard);
  }

  function openGameOver(reason){
    overlayResultLabel.style.display = 'block';
    overlayScore.style.display = 'block';
    overlayScore.textContent = formatNum(score);
    playAgainBtn.textContent = '–ò–≥—Ä–∞—Ç—å';

    if(reason === 'bomb'){
      overlayTitle.textContent = '–ë—É–º! –≠—Ç–æ –±—ã–ª–∞ –±–æ–º–±–∞';
      overlaySub.textContent = '–í—ã –Ω–∞–∂–∞–ª–∏ –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π –∫—Ä—É–≥.';
    } else if(reason === 'misses'){
      overlayTitle.textContent = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!';
      overlaySub.textContent = '–í—ã –ø–æ—Ç–µ—Ä—è–ª–∏ –≤—Å–µ –∂–∏–∑–Ω–∏.';
    } else {
      overlayTitle.textContent = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!';
      overlaySub.textContent = '–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à—ë–Ω.';
    }
    overlayMode = 'gameOver';
    gameOverOverlay.classList.add('visible');
  }

  function endGame(reason=''){
    roundActive = false;
    if(timerId){
      clearInterval(timerId);
      timerId = null;
    }
    circles.forEach(c=>c.classList.remove('active','bomb-visible','green-bonus','yellow-bonus'));
    startBtn.disabled = false;
    addResultToLeaderboard();
    openGameOver(reason);

    resetUI();
    // —Å–±—Ä–æ—Å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–π –∏–≥—Ä—ã
    score = 0;
    diamondsRun = 0;
    starsRun = 0;
    scoreEl.textContent = formatNum(0);
    updateStatsUI();

    misses = 0;
    updateHearts();
    pendingContinue = false;
    startBtn.textContent = '–ò–≥—Ä–∞—Ç—å';
  }

  function setupRoundState(){
    roundActive = true;
    messageEl.textContent = '';

    const level = Math.max(1, unlockedFish + 1);

    // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä—É–≥–æ–≤: –Ω–∞ 1 —É—Ä–æ–≤–Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω
    let currentCircleCount = 3;
    if (level === 1) {
      currentCircleCount = 1;
      circles.forEach((btn, idx)=>{
        btn.style.visibility = (idx === 0) ? 'visible' : 'hidden';
      });
    } else {
      circles.forEach(btn=>btn.style.visibility = 'visible');
    }

    activeIndex = Math.floor(Math.random() * currentCircleCount);

    bombRound = false;
    bombDangerIndex = null;
    greenBonusIndex = null;
    yellowIndex = null;
    isYellowPhase = false;

    let roundType = 'purple';
    if (level >= 3) {
      const r = Math.random();
      if (r < 0.2) roundType = 'bomb';
      else if (r < 0.5) roundType = 'green';
      else roundType = 'purple';
    } else if (level === 2) {
      roundType = Math.random() < 0.4 ? 'green' : 'purple';
    } else {
      roundType = 'purple';
    }

    circles.forEach((btn, idx)=>{
      btn.classList.remove('active','bomb-visible','green-bonus','yellow-bonus');
      const icon = btn.querySelector('.circle-icon');
      if (icon) icon.textContent = '‚ö°';
    });

    const activeBtn = circles[activeIndex];
    const activeIcon = activeBtn.querySelector('.circle-icon');

    if (roundType === 'bomb') {
      bombRound = true;
      bombDangerIndex = activeIndex;

      activeBtn.classList.add('active','bomb-visible');
      if (activeIcon) activeIcon.textContent = '‚ö°';

      const visibleTime = currentRoundTimeMs / 2;
      setTimeout(()=>{
        if (!roundActive) return;
        if (!bombRound) return;
        if (bombDangerIndex !== activeIndex) return;

        activeBtn.classList.remove('bomb-visible');
        activeBtn.classList.add('green-bonus');
        if (activeIcon) activeIcon.textContent = 'üíé';

        bombDangerIndex = null;
        greenBonusIndex = activeIndex;
      }, visibleTime);

    } else if (roundType === 'green') {
      activeBtn.classList.add('active','green-bonus');
      if (activeIcon) activeIcon.textContent = 'üíé';
      greenBonusIndex = activeIndex;

      const half = currentRoundTimeMs / 2;
      setTimeout(()=>{
        if (!roundActive) return;
        if (greenBonusIndex !== activeIndex) return;
        activeBtn.classList.remove('green-bonus');
        activeBtn.classList.add('yellow-bonus');
        if (activeIcon) activeIcon.textContent = '‚ö°';
        yellowIndex = activeIndex;
        isYellowPhase = true;
      }, half);

    } else {
      // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –∫—Ä—É–≥: –≥–æ—Ä–∏—Ç —Å–æ –∑–≤–µ–∑–¥–æ–π –í–ï–°–¨ —Ä–∞—É–Ω–¥ (–±–µ–∑ –º–∏–≥–∞–Ω–∏—è)
      activeBtn.classList.add('active');
      if (activeIcon) activeIcon.textContent = '‚≠ê';
    }
  }

  function nextRound(){
    if (misses >= MAX_MISSES){
      endGame('misses');
      return;
    }

    setupRoundState();

    const thisRoundTime = currentRoundTimeMs;
    roundDurationMs = thisRoundTime;
    roundStartPerf = performance.now();

    const startTime = roundStartPerf;
    timerFill.style.transform='scaleX(1)';

    if(timerId){
      clearInterval(timerId);
    }
    timerId = setInterval(()=>{
      if(!roundActive) return;
      const elapsed = performance.now() - startTime;
      const ratio = Math.max(0, 1 - elapsed/thisRoundTime);
      timerFill.style.transform='scaleX('+ratio+')';
      if(elapsed >= thisRoundTime){
        clearInterval(timerId);
        timerId = null;
        handleTimeout();
      }
    }, 40);
  }

  function handleMissCommon(){
    misses++;
    updateHearts();

    if(misses >= MAX_MISSES){
      endGame('misses');
    } else {
      heartOverlay.classList.add('visible');
      setTimeout(()=>heartOverlay.classList.remove('visible'), 1600);
      pendingContinue = true;
      startBtn.disabled = false;
      startBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
    }
  }

  function handleTimeout(){
    if(!roundActive) return;
    roundActive = false;

    // –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Ä–∞—É–Ω–¥–∞ –¥–µ–ª–∞–µ–º –∫—Ä—É–≥ —á—ë—Ä–Ω—ã–º —Å –º–æ–ª–Ω–∏–µ–π
    const btn = circles[activeIndex];
    if (btn) {
      btn.classList.remove('active','bomb-visible','green-bonus','yellow-bonus');
      const icon = btn.querySelector('.circle-icon');
      if (icon) icon.textContent = '‚ö°';
    }

    if(bombRound && bombDangerIndex !== null){
      bombRound = false;
    }

    handleMissCommon();
  }

  function handleCircleClick(e){
    if(!roundActive) return;
    const idx = Number(e.currentTarget.dataset.index);
    const level = Math.max(1, unlockedFish + 1);

    if(bombDangerIndex !== null && idx === bombDangerIndex){
      roundActive = false;
      endGame('bomb');
      return;
    }

    if(idx === activeIndex){
      let reward = 0;

      if (greenBonusIndex !== null && idx === greenBonusIndex && !isYellowPhase) {
        // –∑–µ–ª—ë–Ω—ã–π: –≤—Å–µ–≥–¥–∞ 100 –∏ 1 –∞–ª–º–∞–∑
        reward = 100;
        score += reward;
        totalCoinsAll += reward;
        diamondsRun += 1;
        totalDiamondsAll += 1;
        showRewardPopup(e.currentTarget, '+100 üíé');
      } else if (yellowIndex !== null && idx === yellowIndex && isYellowPhase) {
        // –∂—ë–ª—Ç—ã–π: –≤—Å–µ–≥–¥–∞ 1 –º–æ–Ω–µ—Ç–∞
        reward = 1;
        score += reward;
        totalCoinsAll += reward;
        showRewardPopup(e.currentTarget, '+1');
      } else {
        // —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π: 50‚Äì1 –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ + –∑–≤–µ–∑–¥–∞
        reward = calcPurpleReward();
        score += reward;
        totalCoinsAll += reward;
        starsRun += 1;
        totalStarsAll += 1;
        showRewardPopup(e.currentTarget, '+'+reward+' ‚≠ê');
      }

      saveTotals();
      updateStatsUI();
      scoreEl.textContent = formatNum(score);

      tryUnlockFish();

      roundActive = false;
      bombRound = false;
      greenBonusIndex = null;
      yellowIndex = null;
      isYellowPhase = false;

      // –°–ø–µ—Ü-–ª–æ–≥–∏–∫–∞ –¥–ª—è 1 —É—Ä–æ–≤–Ω—è:
      // –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –¥–∞—ë–º 0.5 —Å–µ–∫ "—á—ë—Ä–Ω—ã–π —Å –º–æ–ª–Ω–∏–µ–π", –ø–æ—Ç–æ–º —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
      if (level === 1) {
        const btn = e.currentTarget;
        const icon = btn.querySelector('.circle-icon');
        btn.classList.remove('active','green-bonus','yellow-bonus','bomb-visible');
        if (icon) icon.textContent = '‚ö°';

        setTimeout(()=>{
          nextRound();
        }, 500);
      } else {
        nextRound();
      }

    } else {
      roundActive = false;
      handleMissCommon();
    }
  }

  circles.forEach(btn=>btn.addEventListener('click',handleCircleClick));

  function startGame(){
    currentRoundTimeMs = BASE_ROUND_TIME_MS;
    roundTimeLabel.textContent = (currentRoundTimeMs/1000).toFixed(1) + ' c';

    if(!playerName && !playerNameInput.value.trim()){
      playerNameInput.value = '–ò–≥—Ä–æ–∫';
    }
    if(!playerName){
      savePlayerName();
    }

    startBtn.disabled = true;
    gameOverOverlay.classList.remove('visible');
    misses = 0;
    updateHearts();

    scoreEl.textContent = formatNum(score);

    diamondsRun = 0;
    starsRun = 0;
    updateStatsUI();

    runStartTimeMs = Date.now();
    runStartUnlockedFish = unlockedFish;
    runFishGained = 0;

    resetUI();
    updateFishProgress();
    nextRound();
  }

  function continueAfterMiss(){
    pendingContinue = false;
    heartOverlay.classList.remove('visible');
    startBtn.disabled = true;
    startBtn.textContent = '–ò–≥—Ä–∞—Ç—å';
    messageEl.textContent = '';
    updateFishProgress();
    nextRound();
  }

  function showRulesOverlay(){
    overlayTitle.textContent = '–ü—Ä–∞–≤–∏–ª–∞';
    overlaySub.textContent = '–ö–∞–∫ –∏–≥—Ä–∞—Ç—å –≤ ‚Äú–ë—ã—Å—Ç—Ä—ã–π –∫–ª–∏–∫‚Äù';
    overlayResultLabel.style.display = 'none';
    overlayScore.style.display = 'none';
    playAgainBtn.textContent = '–ò–≥—Ä–∞—Ç—å';
    overlayMode = 'rules';
    gameOverOverlay.classList.add('visible');
  }

  function showHelpOverlay(){ helpOverlay.classList.add('visible'); }
  function hideHelpOverlay(){
    helpOverlay.classList.remove('visible');
    helpSeen = true;
    try{ localStorage.setItem('fastClickHelpSeen','1'); }catch(e){}
  }

  playAgainBtn.addEventListener('click', ()=>{
    gameOverOverlay.classList.remove('visible');
  });

  startBtn.addEventListener('click', ()=>{
    if(pendingContinue){
      continueAfterMiss();
    } else {
      startGame();
    }
  });

  rulesBtn.addEventListener('click', showRulesOverlay);

  helpCloseBtn.addEventListener('click', ()=>{ hideHelpOverlay(); });

  saveNameBtn.addEventListener('click', ()=>{ savePlayerName(); });
  playerNameInput.addEventListener('click', ()=>{
    if(playerNameInput.readOnly){
      playerNameInput.readOnly = false;
      saveNameBtn.style.display = 'inline-block';
    }
  });
  playerNameInput.addEventListener('input', ()=>{
    if(!playerNameInput.readOnly){
      saveNameBtn.style.display = 'inline-block';
    }
  });
  playerNameInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ savePlayerName(); }
  });

  buildFishGrid();
  resetUI();
  loadPlayerName();
  renderLeaderboard(loadLeaderboard());
  loadCloudLeaderboard();
  loadTotals();

  showHelpOverlay();
</script>
